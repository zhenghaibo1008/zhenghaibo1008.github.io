<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.4.1 by Michael Rose
  Copyright 2017 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>负载均衡 - ServiceComb</title>




<meta name="description" content="负载均衡">




<meta name="author" content="">

<meta property="og:locale" content="zh_CN">
<meta property="og:site_name" content="ServiceComb">
<meta property="og:title" content="负载均衡">


  <link rel="canonical" href="http://localhost:4000/docs/load-balance/">
  <meta property="og:url" content="http://localhost:4000/docs/load-balance/">



  <meta property="og:description" content="负载均衡">



  <meta name="twitter:site" content="@ServiceComb">
  <meta name="twitter:title" content="负载均衡">
  <meta name="twitter:description" content="负载均衡">
  <meta name="twitter:url" content="http://localhost:4000/docs/load-balance/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2017-06-13T15:24:11+08:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "ServiceComb",
      "url" : "http://localhost:4000",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="ServiceComb Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->

<meta http-equiv="cleartype" content="on">
    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="http://localhost:4000/">ServiceComb</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/docs/quick-start-guide/">快速入门</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/docs/user-guide/">用户手册</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/docs/community">社区</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/docs/developers">开发</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/year-archive/">博文</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/about/project">关于</a></li>
          
        </ul>
        <button><div class="navicon"></div></button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">切换菜单</label>
  <ul class="nav__items">
    
      <li>
        
          
          

          <a href="http://localhost:4000/docs/user-guide/"><span class="nav__sub-title">用户手册</span></a>
        

        
        <ul>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/quick-start-guide/" class="">快速入门</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/user-guide/" class="">ServiceComb是什么</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/start-sc/" class="">如何启动Service Center</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/jaxrs-sample/" class="">JAX RS例子</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/spring-mvc-sample/" class="">Spring MVC例子</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/pojo-sample/" class="">透明RPC例子</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/codefirst-sample/" class="">CodeFirst例子</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/faq/" class="">常见问题</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">开发配置</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/dependency-config/" class="">依赖包配置</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/sdk-config/" class="">SDK配置</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">通信通道</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/rest-transport/" class="">rest方式</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/highway-transport/" class="">highway方式</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">处理链开发</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/handler-summary/" class="">概述</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/service-management/" class="">服务治理</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/load-balance/" class="active">负载均衡</a></li>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/qps/" class="">QPS流控</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">部署</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="http://localhost:4000/docs/deployment/" class="">如何部署</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="负载均衡">
    <meta itemprop="description" content="负载均衡">
    <meta itemprop="datePublished" content="June 13, 2017">
    <meta itemprop="dateModified" content="June 06, 2017">

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">负载均衡
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        <aside class="sidebar__right">
<nav class="toc">
    <header><h4 class="nav__title"><i class="fa fa-file-text"></i> 在本页上</h4></header>
<ul class="toc__menu" id="markdown-toc">
  <li><a href="#场景介绍" id="markdown-toc-场景介绍">场景介绍</a></li>
  <li><a href="#配置说明" id="markdown-toc-配置说明">配置说明</a></li>
  <li><a href="#配置项" id="markdown-toc-配置项">配置项</a></li>
  <li><a href="#实施指导" id="markdown-toc-实施指导">实施指导</a></li>
  <li><a href="#实施负载均衡" id="markdown-toc-实施负载均衡">实施负载均衡</a></li>
  <li><a href="#通过服务version路由分流" id="markdown-toc-通过服务version路由分流">通过服务version路由分流</a></li>
  <li><a href="#通过实例properties路由分流" id="markdown-toc-通过实例properties路由分流">通过实例properties路由分流</a></li>
</ul>

  </nav>
</aside>

<h2 id="场景介绍">场景介绍</h2>

<p>当应用访问一个集群部署的服务时，会涉及到路由负载均衡。 当前提供的基于Ribbon的方案，可以通过配置文件配置负载均衡策略，当前支持随机，顺序，基于响应时间的权值等多种负载均衡路由策略。这些策略可以根据用户的场景进行修改配置。</p>

<h2 id="配置说明">配置说明</h2>

<p>命名规范如下：</p>

<p>cse.loadbalance.[MicroServiceName].[property name]</p>

<ul>
  <li>只能配置客户端。</li>
  <li>对于全局配置，不需要指定MicroServiceName。针对特定的微服务的配置，需要增加MicroServiceName。
负载均衡示例如下：</li>
</ul>

<p>cse.loadbalance.NFLoadBalancerRuleClassName
cse.loadbalance.DemoService.NFLoadBalancerRuleClassName</p>

<h2 id="配置项">配置项</h2>

<p>负载均衡配置项如表1所示。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">配置项</th>
      <th style="text-align: center">配置值参考</th>
      <th style="text-align: center">说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">cse.loadbalance.NFLoadBalancerRuleClassName</td>
      <td style="text-align: center">com.netflix.loadbalancer.RoundRobinRule</td>
      <td style="text-align: center">基于轮询的路由选择策略。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.NFLoadBalancerRuleClassName</td>
      <td style="text-align: center">com.netflix.loadbalancer.RandomRule</td>
      <td style="text-align: center">基于随机的路由选择策略。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.NFLoadBalancerRuleClassName</td>
      <td style="text-align: center">com.netflix.loadbalancer.WeightedResponseTimeRule</td>
      <td style="text-align: center">基于服务器响应时间的路由选择策略。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.NFLoadBalancerRuleClassName</td>
      <td style="text-align: center">com.huawei.paas.cse.loadbalance.SessionStickinessRule</td>
      <td style="text-align: center">会话保持路由选择策略。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.SessionStickinessRule.sessionTimeoutInSeconds</td>
      <td style="text-align: center">30</td>
      <td style="text-align: center">客户端闲置时间，超过限制后选择后面的服务器。（说明：暂不支持微服务配置。e.g. cse.loadbalance.SessionStickinessRule.sessionTimeoutInSeconds，不能配置为cse.loadbalance.DemoService.SessionStickinessRule.sessionTimeoutInSeconds）。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.SessionStickinessRule.successiveFailedTimes</td>
      <td style="text-align: center">5</td>
      <td style="text-align: center">客户端失败次数，超过后会切换服务器（暂不支持微服务配置）。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.retryEnabled</td>
      <td style="text-align: center">FALSE</td>
      <td style="text-align: center">负载均衡捕获到服务调用异常，是否进行重试。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.retryOnNext</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">尝试新的服务器的次数。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.retryOnSame</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">同一个服务器尝试的次数。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.isolation.enabled</td>
      <td style="text-align: center">FALSE</td>
      <td style="text-align: center">是否开启故障实例隔离功能。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.isolation.enableRequestThreshold</td>
      <td style="text-align: center">20</td>
      <td style="text-align: center">当实例的调用总次数达到该值时开始进入隔离逻辑门槛，需为整数，默认值为20。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.isolation.errorThresholdPercentage</td>
      <td style="text-align: center">20</td>
      <td style="text-align: center">实例故障隔离错误百分比，需为(0,100]区间整数，默认值为20，大于该值时该实例被隔离。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.isolation.singleTestTime</td>
      <td style="text-align: center">10000</td>
      <td style="text-align: center">故障实例单点测试时间，单位为ms，默认值为10000，当前时间与该实例上次被调用到的时间差大于该值时该实例有机会被调用到。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.transactionControl.policy</td>
      <td style="text-align: center">io.servicecomb.loadbalance.filter.SimpleTransactionControlFilter</td>
      <td style="text-align: center">动态路由分流策略，框架提供了简单的分流机制，开发者也可以实现自定义的分流过滤策略。</td>
    </tr>
    <tr>
      <td style="text-align: center">cse.loadbalance.transactionControl.options</td>
      <td style="text-align: center">key/value pairs</td>
      <td style="text-align: center">针对SimpleTransactionControlFilter分流策略的配置项，可添加任意项过滤标签。</td>
    </tr>
  </tbody>
</table>

<h2 id="实施指导">实施指导</h2>

<p>配置文件路径：src\main\resources\microservice.yaml。</p>

<h2 id="实施负载均衡">实施负载均衡</h2>

<p>实施负载均衡的步骤如下。</p>

<ul>
  <li>在处理链配置项当中增加负载均衡一项，代码如下。
    <div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">cse</span><span class="pi">:</span>
<span class="s">......</span>
<span class="s">handler</span><span class="pi">:</span>
  <span class="s">chain</span><span class="pi">:</span>
    <span class="s">Consumer</span><span class="pi">:</span>
     <span class="s">default</span><span class="pi">:</span> <span class="s">loadbalance</span>
<span class="s">......</span>
</code></pre>
    </div>
  </li>
  <li>增加路由策略，代码如下。
    <div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">cse：</span>
<span class="s">......</span>
<span class="s">loadbalance</span><span class="pi">:</span>
  <span class="s">NFLoadBalancerRuleClassName</span><span class="pi">:</span> <span class="s">com.netflix.loadbalancer.RoundRobinRule</span>
<span class="s">......</span>   
</code></pre>
    </div>
  </li>
</ul>

<p class="notice--warning"><strong>Note:</strong>路由策略默认配置为com.netflix.loadbalancer.RoundRobinRule。
其中 NFLoadBalancerRuleClassName为具体的路由策略，通过配置不同的实现类的路径来实现不同的路由策略，通常的路由策略配置如下：
轮询： com.netflix.loadbalancer.RoundRobinRule
随机：com.netflix.loadbalancer.RandomRule
权值：com.netflix.loadbalancer.WeightedResponseTimeRule
会话保持：com.huawei.paas.cse.loadbalance.SessionStickinessRule</p>

<h2 id="通过服务version路由分流">通过服务version路由分流</h2>

<p>在灰度发布的情况下，Consumer可以通过下面的方式指定访问的服务版本号。</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">cse</span><span class="pi">:</span>
  <span class="s">references</span><span class="pi">:</span>
    <span class="s">microserviceName</span><span class="pi">:</span>
      <span class="s">version-rule</span><span class="pi">:</span> <span class="s">latest</span>       <span class="c1"># 支持模糊匹配，如1.0+</span>
</code></pre>
</div>

<p class="notice--warning"><strong>Note:</strong> 默认情况下，只能够访问最新版本的服务，业务可以指定具体版本号。 version-rule的详细规则请参考“服务中心契约”的描述。</p>

<h2 id="通过实例properties路由分流">通过实例properties路由分流</h2>

<ul>
  <li>配置分流策略
可为每个微服务配置路由分流策略，通过配置中心动态更新，如下:</li>
</ul>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">cse</span><span class="pi">:</span>
  <span class="s">loadbalance</span><span class="pi">:</span>
    <span class="s">microserviceName</span><span class="pi">:</span>             <span class="c1"># 如果为跨app访问，则配置为appId:serviceName</span>
      <span class="s">transactionControl</span><span class="pi">:</span>
        <span class="s">policy</span><span class="pi">:</span> <span class="s">io.servicecomb.loadbalance.filter.SimpleTransactionControlFilter</span>
        <span class="s">options</span><span class="pi">:</span>
          <span class="s">tag0</span><span class="pi">:</span> <span class="s">value0</span>
</code></pre>
</div>

<p class="notice--warning"><strong>Note:</strong> 这里的SimpleTransactionControlFilter是由框架提供的简单路由分流策略，选中的实例的properties必须包含options中的所有tags。</p>

<ul>
  <li>自定义分流策略
业务可根据自己的需求实现自定义的分流策略，代码如下:
```java
import io.servicecomb.loadbalance.filter.TransactionControlFilter;
import com.netflix.loadbalancer.Server;</li>
</ul>

<p>public class MyFilter extends TransactionControlFilter {</p>

<div class="highlighter-rouge"><pre class="highlight"><code>@Override
public List&lt;Server&gt; getFilteredListOfServers(List&lt;Server&gt; servers) {
    ......
    for (Server server : servers) {
      CseServer cseServer = (CseServer) server;
      Map&lt;String, String&gt; propertiesMap = cseServer.getInstance().getProperties();
      ......
    }
    ......
    return null;
} } ```
</code></pre>
</div>

<p>自定义的分流策略必须继承自框架提供的io.servicecomb.loadbalance.filter.TransactionControlFilter抽象类，配置到特定的微服务。</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">cse</span><span class="pi">:</span>
  <span class="s">loadbalance</span><span class="pi">:</span>
    <span class="s">microserviceName</span><span class="pi">:</span>
      <span class="s">transactionControl</span><span class="pi">:</span>
        <span class="s">policy</span><span class="pi">:</span> <span class="s">com.path.to.class.MyFilter</span>
</code></pre>
</div>

        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> 最新的:</strong> <time datetime="2017-06-06">June 06, 2017</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="http://localhost:4000/docs/service-management/" class="pagination--pager" title="服务治理
">向前</a>
    
    
      <a href="http://localhost:4000/docs/qps/" class="pagination--pager" title="QPS流控
">向后</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>


    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <div align="center" style="margin: 1em 0;">
    <ins class="adsbygoogle"
         style="display:block; border-bottom: initial;"
         data-ad-client="ca-pub-7328585512091257"
         data-ad-slot="3049671934"
         data-ad-format="auto"></ins>
    </div>

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>关注:</strong></li>
    
    
      <li><a href="https://twitter.com/ServiceComb"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2017 ServiceComb. 技术来自于 <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    <script src="http://localhost:4000/assets/js/main.min.js"></script>





  </body>
</html>
